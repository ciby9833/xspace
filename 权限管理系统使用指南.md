# 权限管理系统使用指南

## 🎯 系统概述

新的权限管理系统提供了完全动态的角色和权限配置功能，替代了之前硬编码的权限系统。管理员可以通过前端界面灵活地创建角色、分配权限，无需修改代码。

## 🏗️ 系统架构

### 权限模块
- **用户管理** (`user.*`): 查看、创建、编辑、删除用户
- **剧本管理** (`script.*`): 剧本的完整生命周期管理
- **订单管理** (`order.*`): 订单处理和分配
- **门店管理** (`store.*`): 门店信息管理
- **公司管理** (`company.*`): 公司信息管理  
- **系统管理** (`system.*`): 系统设置和权限管理

### 默认角色
- **管理员** (admin): 拥有所有权限
- **SPV** (supervisor): 大部分管理权限
- **店长** (manager): 门店相关权限
- **客服** (service): 订单和客户服务权限
- **主持人** (host): 基础查看权限

## 🚀 快速开始

### 1. 数据库初始化

```bash
# 在后端目录执行
cd backend

# 执行权限系统迁移
node src/database/migrate-permissions.js

# 或者使用完整初始化脚本
node src/scripts/init-permissions.js
```

### 2. 启动服务

```bash
# 启动后端服务
cd backend
npm start

# 启动前端服务
cd frontend  
npm run dev
```

### 3. 访问权限管理

1. 登录系统 (http://localhost:5173)
2. 使用管理员或主账号身份
3. 点击左侧菜单 "权限管理"

## 🔧 功能使用

### 角色管理

#### 创建自定义角色
1. 在权限管理页面点击 "新建角色"
2. 填写角色信息：
   - **角色名称**: 英文标识符 (如: `custom_manager`)
   - **显示名称**: 中文显示名 (如: `自定义经理`)
   - **角色描述**: 详细描述角色职责
3. 点击确定创建

#### 编辑角色
- 只能编辑自定义角色 (非系统角色)
- 可修改显示名称和描述
- 系统角色显示蓝色标签，不可编辑

#### 删除角色
- 只能删除未被使用的自定义角色
- 系统会检查是否有用户绑定该角色

### 权限配置

#### 查看角色权限
1. 在左侧角色列表选择目标角色
2. 右侧显示该角色的权限配置
3. 权限按模块分组展示

#### 分配权限
1. 选择角色后，勾选需要的权限
2. 可使用模块级 "全选" 快速选择
3. 点击 "保存权限" 应用更改
4. 点击 "重置" 恢复到保存前状态

#### 权限说明
- ✅ **查看权限** (`*.view`): 可以查看相关数据
- ✏️ **编辑权限** (`*.edit`): 可以修改数据
- ➕ **创建权限** (`*.create`): 可以创建新数据
- 🗑️ **删除权限** (`*.delete`): 可以删除数据
- 🔧 **管理权限** (`*.manage`): 包含增删改查的完整权限

### 用户角色分配

#### 在用户管理页面分配角色
1. 进入 "用户管理" 页面
2. 找到目标用户，点击 "分配角色"
3. 选择新角色后确认
4. 系统立即生效

#### 创建用户时指定角色
1. 点击 "添加用户"
2. 在角色下拉框选择合适的角色
3. 完成用户创建

## 🔐 权限检查机制

### 兼容性设计
系统采用向后兼容的权限检查机制：
1. **优先使用新权限系统**: 从数据库动态获取用户权限
2. **回退到旧系统**: 如果新系统失败，使用JWT中的权限信息
3. **特殊角色处理**: 平台管理员和主账号保持原有的完整权限

### API权限验证
每个需要权限的API接口都通过中间件验证：
```javascript
// 示例：剧本管理权限检查
router.post('/scripts', 
  authenticateToken,           // 身份验证
  checkPermission('script.manage'), // 权限检查
  scriptController.create      // 业务逻辑
);
```

## 📱 前端权限控制

### 菜单显示控制
```vue
<!-- 只有有权限的用户才能看到菜单项 -->
<a-menu-item 
  key="/permissions"
  v-if="['平台管理员', '主账号'].includes(authStore.user?.role)"
>
  <SettingOutlined />
  <span>权限管理</span>
</a-menu-item>
```

### 按钮权限控制
```vue
<!-- 根据权限显示/隐藏操作按钮 -->
<a-button 
  type="primary" 
  @click="showCreateModal"
  :disabled="!canManagePermissions"
>
  新建角色
</a-button>
```

## 🛠️ 开发指南

### 添加新权限

1. **更新迁移脚本** (`migrate-permissions.js`)
```javascript
{ module: 'order', name: 'export', display_name: '导出订单', key: 'order.export' }
```

2. **在路由中使用权限**
```javascript
router.get('/orders/export', 
  authenticateToken,
  checkPermission('order.export'),
  orderController.exportOrders
);
```

3. **前端权限检查**
```javascript
const canExportOrders = computed(() => {
  return authStore.hasPermission('order.export')
})
```

### 创建新模块

1. **添加权限模块**
```javascript
{ name: 'inventory', display_name: '库存管理', description: '库存相关功能', sort_order: 7 }
```

2. **定义模块权限**
```javascript
{ module: 'inventory', name: 'view', display_name: '查看库存', key: 'inventory.view' },
{ module: 'inventory', name: 'manage', display_name: '管理库存', key: 'inventory.manage' }
```

## 🚨 注意事项

### 数据安全
- 删除角色前会检查是否有用户使用
- 系统角色不能被删除或修改名称
- 权限更改立即生效，无需重启服务

### 性能考虑
- 权限检查使用了数据库索引优化
- JWT Token仍包含权限信息作为缓存
- 权限数据建议定期清理无效记录

### 错误处理
- 权限检查失败自动回退到旧系统
- 详细的错误日志便于排查问题
- 用户友好的错误提示

## 📊 API接口文档

### 权限管理接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/permission/structure` | GET | 获取权限结构 |
| `/api/permission/roles` | GET | 获取角色列表 |
| `/api/permission/roles/:id` | GET | 获取角色详情 |
| `/api/permission/roles` | POST | 创建角色 |
| `/api/permission/roles/:id` | PUT | 更新角色 |
| `/api/permission/roles/:id` | DELETE | 删除角色 |
| `/api/permission/roles/:id/permissions` | PUT | 分配权限 |
| `/api/permission/users/:id/role` | PUT | 更新用户角色 |
| `/api/permission/initialize` | POST | 初始化默认权限 |

### 请求示例

**创建角色**
```bash
curl -X POST http://localhost:3000/api/permission/roles \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "store_supervisor",
    "display_name": "门店主管",
    "description": "负责门店日常运营管理"
  }'
```

**分配权限**
```bash
curl -X PUT http://localhost:3000/api/permission/roles/ROLE_ID/permissions \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "permission_ids": ["perm_id_1", "perm_id_2", "perm_id_3"]
  }'
```

## 🎯 最佳实践

### 角色设计原则
1. **最小权限原则**: 只分配工作必需的权限
2. **角色继承**: 高级角色包含低级角色的权限
3. **职责分离**: 不同职能使用不同角色
4. **定期审查**: 定期检查和调整权限配置

### 权限命名规范
- 使用 `模块.操作` 格式
- 操作使用动词: `view`, `create`, `edit`, `delete`, `manage`
- 保持一致性和可读性

### 安全建议
- 定期备份权限配置
- 记录权限变更日志
- 限制权限管理员数量
- 监控异常权限使用

---

🎉 **恭喜！** 您现在已经掌握了完整的权限管理系统。系统提供了灵活的权限配置能力，可以根据业务需求自由定制角色和权限，大大提升了系统的可维护性和扩展性。 