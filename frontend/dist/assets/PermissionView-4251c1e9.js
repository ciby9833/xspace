import{x as y,a as He,r as m,b as W,k as F,l as Ze,q as Ge,c as r,o as i,d as k,e as v,g as t,w as l,m as R,f as X,P as Je,h as f,t as _,n as h,i as C,s as S,v as $,E as Qe,L as We,I as Y,H as Xe,a2 as Ye}from"./index-979b8016.js";import{_ as ea}from"./_plugin-vue_export-helper-c27b6911.js";const x={getPermissionStructure(){return y.get("/api/permissions/structure")},getRoles(u=null){const c=u?{company_id:u}:{};return y.get("/api/permissions/roles",{params:c})},getRoleDetails(u){return y.get(`/api/permissions/roles/${u}`)},createRole(u){return y.post("/api/permissions/roles",u)},updateRole(u,c){return y.put(`/api/permissions/roles/${u}`,c)},deleteRole(u){return y.delete(`/api/permissions/roles/${u}`)},assignPermissions(u,c){return y.put(`/api/permissions/roles/${u}/permissions`,{permission_ids:c})},updateUserRole(u,c){return y.put(`/api/permissions/users/${u}/role`,{role_id:c})},getUserPermissions(u){return y.get(`/api/permissions/users/${u}/permissions`)},getCreatableRoleLevels(){return y.get("/api/permissions/role-levels/creatable")},getCompaniesForRole(){return y.get("/api/permissions/companies/for-role")},checkResourceAccess(u,c){return y.get("/api/permissions/check-access",{params:{resource_type:u,resource_id:c}})},getPermissionStats(){return y.get("/api/permissions/stats")}};const aa={class:"permission-view"},sa={key:0,class:"filter-section"},la={class:"role-info"},ta={class:"role-name"},oa={class:"role-description"},na={class:"role-meta"},ra={class:"role-level"},ia={key:0,class:"role-company"},ua={key:1,class:"role-company"},ca={key:0,class:"role-actions"},da={key:0,class:"empty-state"},pa={key:1},_a={class:"role-detail-info"},ma={class:"permission-modules"},va={class:"permission-list"},fa={class:"permission-item"},ya={class:"permission-name"},ga={class:"permission-desc"},ka={__name:"PermissionView",setup(u){const c=He(),L=m([]),d=m(null),D=m([]),p=W({}),E=W({}),w=m(""),I=m([]),ee=m([]),ae=m([]),T=m(!1),A=m(!1),B=m(!1),O=m(!1),P=m(!1),N=m(!1),se=m(null),K=m([]),o=W({name:"",display_name:"",description:"",role_level:"",company_id:""}),_e={name:[{required:!0,message:"请输入角色名称"},{pattern:/^[a-zA-Z0-9_]+$/,message:"只能包含字母、数字和下划线"}],display_name:[{required:!0,message:"请输入显示名称"}],role_level:[{required:!0,message:"请选择角色层级"}],company_id:[{required:!0,message:"请选择归属公司",validator:(e,a)=>oe.value&&!a?Promise.reject("请选择归属公司"):Promise.resolve()}]},U=F(()=>{var e;return((e=c.user)==null?void 0:e.account_level)==="platform"}),H=F(()=>{var e;return((e=c.user)==null?void 0:e.account_level)==="company"}),me=F(()=>{var e;return((e=c.user)==null?void 0:e.account_level)==="store"}),le=F(()=>c.hasPermission("system.role")||c.hasPermission("system.permission")),te=F(()=>U.value||H.value),ve=F(()=>w.value?w.value==="platform"?L.value.filter(e=>e.role_level==="platform"):L.value.filter(e=>e.company_id===w.value):L.value),oe=F(()=>o.role_level&&o.role_level!=="platform"&&U.value),j=e=>{var a,n;return!le.value||e.name==="superadmin"&&e.is_system_role?!1:U.value?!0:H.value?e.company_id===((a=c.user)==null?void 0:a.company_id)&&["company","store"].includes(e.role_level):me.value?e.company_id===((n=c.user)==null?void 0:n.company_id)&&e.role_level==="store":!1},ne=e=>!(!j(e)||e.is_system_role||e.name==="superadmin"),Z=e=>!e||e.name==="superadmin"&&e.is_system_role?!1:j(e),fe=e=>e.role_level==="platform"?"purple":e.role_level==="company"?"blue":e.role_level==="store"?"green":"default",ye=e=>e.is_system_role?"系统角色":G(e.role_level),G=e=>({platform:"平台级",company:"公司级",store:"门店级"})[e]||e,ge=e=>e.permissions.every(a=>p[a.id]),ke=e=>{const a=e.permissions.filter(n=>p[n.id]).length;return a>0&&a<e.permissions.length},V=async()=>{try{T.value=!0;const e=await x.getRoles(w.value==="platform"?null:w.value);L.value=e.data||[]}catch(e){R.error("加载角色列表失败"),console.error("加载角色失败:",e)}finally{T.value=!1}},he=async()=>{try{const e=await x.getPermissionStructure();D.value=e.data||[],K.value=D.value.map(a=>a.id)}catch(e){R.error("加载权限结构失败"),console.error("加载权限结构失败:",e)}},be=async()=>{try{const e=await x.getCreatableRoleLevels();ee.value=e.data||[]}catch(e){console.error("加载可创建角色层级失败:",e)}},Re=async()=>{try{const e=await x.getCompaniesForRole();ae.value=e.data||[],U.value?I.value=e.data||[]:H.value&&(I.value=e.data.filter(a=>{var n;return a.id===((n=c.user)==null?void 0:n.company_id)}))}catch(e){console.error("加载公司列表失败:",e)}},Ce=()=>{d.value=null,Object.keys(p).forEach(e=>{delete p[e]}),V()},we=()=>{o.company_id=""},Pe=async e=>{d.value=e,await xe(e.id)},xe=async e=>{var a;try{A.value=!0;const n=await x.getRoleDetails(e);Object.keys(p).forEach(g=>{delete p[g]}),Object.keys(E).forEach(g=>{delete E[g]}),(a=n.data)!=null&&a.permissions&&n.data.permissions.forEach(g=>{p[g.id]=!0,E[g.id]=!0})}catch(n){R.error("加载角色权限失败"),console.error("加载角色权限失败:",n)}finally{A.value=!1}},Ee=(e,a)=>{e.permissions.forEach(n=>{p[n.id]=a})},Ue=()=>{Object.keys(p).forEach(e=>{delete p[e]}),Object.keys(E).forEach(e=>{p[e]=!0})},Fe=async()=>{if(d.value)try{B.value=!0;const e=Object.keys(p).filter(a=>p[a]);await x.assignPermissions(d.value.id,e),Object.keys(E).forEach(a=>{delete E[a]}),e.forEach(a=>{E[a]=!0}),R.success("权限保存成功")}catch(e){R.error("权限保存失败"),console.error("权限保存失败:",e)}finally{B.value=!1}},Me=async()=>{P.value=!1,o.name="",o.display_name="",o.description="",o.role_level="",o.company_id="",await be(),O.value=!0},Oe=e=>{P.value=!0,o.name=e.name,o.display_name=e.display_name,o.description=e.description||"",o.role_level=e.role_level,o.company_id=e.company_id||"",o.id=e.id,O.value=!0},Se=async()=>{try{await se.value.validate(),N.value=!0,P.value?(await x.updateRole(o.id,{display_name:o.display_name,description:o.description}),R.success("角色更新成功")):(await x.createRole(o),R.success("角色创建成功")),O.value=!1,await V()}catch(e){if(e.errorFields)return;R.error(P.value?"角色更新失败":"角色创建失败"),console.error("角色操作失败:",e)}finally{N.value=!1}},$e=async e=>{var a;try{await x.deleteRole(e),R.success("角色删除成功"),((a=d.value)==null?void 0:a.id)===e&&(d.value=null,Object.keys(p).forEach(n=>{delete p[n]})),await V()}catch(n){R.error("角色删除失败"),console.error("角色删除失败:",n)}};return Ze(()=>o.role_level,()=>{o.role_level==="platform"&&(o.company_id="")}),Ge(async()=>{await Promise.all([he(),Re()]),U.value?w.value="platform":w.value="",await V()}),(e,a)=>{const n=r("a-button"),g=r("a-select-option"),J=r("a-select"),M=r("a-form-item"),re=r("a-form"),ie=r("a-divider"),Le=r("a-tag"),je=r("a-popconfirm"),Ve=r("a-list-item"),qe=r("a-list"),ue=r("a-card"),Q=r("a-col"),ze=r("a-space"),De=r("a-empty"),q=r("a-descriptions-item"),Ie=r("a-descriptions"),ce=r("a-checkbox"),de=r("a-row"),Te=r("a-collapse-panel"),Ae=r("a-collapse"),Be=r("a-spin"),pe=r("a-input"),Ne=r("a-textarea"),Ke=r("a-modal");return i(),k("div",aa,[a[16]||(a[16]=v("div",{class:"page-header"},[v("h1",null,"权限管理"),v("p",null,"管理系统角色和权限配置")],-1)),t(de,{gutter:24},{default:l(()=>[t(Q,{xs:24,lg:8},{default:l(()=>[t(ue,{title:"角色管理",class:"role-card"},{extra:l(()=>[t(n,{type:"primary",onClick:Me,disabled:!le.value},{default:l(()=>[t(X(Je)),a[10]||(a[10]=f(" 新建角色 "))]),_:1,__:[10]},8,["disabled"])]),default:l(()=>[te.value?(i(),k("div",sa,[t(re,{layout:"inline",class:"filter-form"},{default:l(()=>[t(M,{label:"查看范围"},{default:l(()=>[t(J,{value:w.value,"onUpdate:value":a[0]||(a[0]=s=>w.value=s),onChange:Ce,style:{width:"200px"},placeholder:"选择查看范围"},{default:l(()=>[t(g,{value:""},{default:l(()=>[f(_(U.value?"全部角色":"本公司全部角色"),1)]),_:1}),U.value?(i(),h(g,{key:0,value:"platform"},{default:l(()=>a[11]||(a[11]=[f(" 仅平台级角色 ")])),_:1,__:[11]})):C("",!0),(i(!0),k(S,null,$(I.value,s=>(i(),h(g,{key:s.id,value:s.id},{default:l(()=>[f(_(s.display_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})])):C("",!0),te.value?(i(),h(ie,{key:1,style:{margin:"16px 0"}})):C("",!0),t(qe,{loading:T.value,"data-source":ve.value,class:"role-list"},{renderItem:l(({item:s})=>{var b;return[t(Ve,{class:Qe([{active:((b=d.value)==null?void 0:b.id)===s.id},"role-item"]),onClick:z=>Pe(s)},{default:l(()=>[v("div",la,[v("div",ta,[f(_(s.display_name)+" ",1),t(Le,{color:fe(s),size:"small"},{default:l(()=>[f(_(ye(s)),1)]),_:2},1032,["color"])]),v("div",oa,_(s.description),1),v("div",na,[v("span",ra,_(G(s.role_level)),1),s.company_name?(i(),k("span",ia," 归属: "+_(s.company_name),1)):s.role_level==="platform"?(i(),k("span",ua," 归属: 平台 ")):C("",!0)])]),j(s)||ne(s)?(i(),k("div",ca,[j(s)?(i(),h(n,{key:0,type:"text",size:"small",onClick:Y(z=>Oe(s),["stop"])},{default:l(()=>[t(X(We))]),_:2},1032,["onClick"])):C("",!0),ne(s)?(i(),h(je,{key:1,title:"确定要删除这个角色吗？",onConfirm:z=>$e(s.id),onClick:a[1]||(a[1]=Y(()=>{},["stop"]))},{default:l(()=>[t(n,{type:"text",size:"small",danger:""},{default:l(()=>[t(X(Xe))]),_:1})]),_:2},1032,["onConfirm"])):C("",!0)])):C("",!0)]),_:2},1032,["class","onClick"])]}),_:1},8,["loading","data-source"])]),_:1})]),_:1}),t(Q,{xs:24,lg:16},{default:l(()=>[t(ue,{title:d.value?`${d.value.display_name} - 权限配置`:"请选择角色",class:"permission-card"},Ye({default:l(()=>[d.value?(i(),k("div",pa,[v("div",_a,[t(Ie,{column:2,size:"small"},{default:l(()=>[t(q,{label:"角色名称"},{default:l(()=>[f(_(d.value.display_name),1)]),_:1}),t(q,{label:"角色层级"},{default:l(()=>[f(_(G(d.value.role_level)),1)]),_:1}),t(q,{label:"归属公司"},{default:l(()=>[f(_(d.value.company_name||"平台"),1)]),_:1}),t(q,{label:"创建者"},{default:l(()=>[f(_(d.value.created_by_username||"系统"),1)]),_:1})]),_:1})]),t(ie),t(Be,{spinning:A.value},{default:l(()=>[v("div",ma,[t(Ae,{activeKey:K.value,"onUpdate:activeKey":a[3]||(a[3]=s=>K.value=s),ghost:""},{default:l(()=>[(i(!0),k(S,null,$(D.value,s=>(i(),h(Te,{key:s.id,header:s.display_name,class:"permission-module"},{extra:l(()=>[t(ce,{checked:ge(s),indeterminate:ke(s),onChange:b=>Ee(s,b.target.checked),onClick:a[2]||(a[2]=Y(()=>{},["stop"])),disabled:!Z(d.value)},{default:l(()=>a[14]||(a[14]=[f(" 全选 ")])),_:2,__:[14]},1032,["checked","indeterminate","onChange","disabled"])]),default:l(()=>[v("div",va,[t(de,{gutter:[16,8]},{default:l(()=>[(i(!0),k(S,null,$(s.permissions,b=>(i(),h(Q,{key:b.id,xs:24,sm:12,md:8},{default:l(()=>[t(ce,{checked:p[b.id],"onUpdate:checked":z=>p[b.id]=z,disabled:!Z(d.value)},{default:l(()=>[v("div",fa,[v("div",ya,_(b.display_name),1),v("div",ga,_(b.description),1)])]),_:2},1032,["checked","onUpdate:checked","disabled"])]),_:2},1024))),128))]),_:2},1024)])]),_:2},1032,["header"]))),128))]),_:1},8,["activeKey"])])]),_:1},8,["spinning"])])):(i(),k("div",da,[t(De,{description:"请从左侧选择一个角色来配置权限"})]))]),_:2},[d.value&&Z(d.value)?{name:"extra",fn:l(()=>[t(ze,null,{default:l(()=>[t(n,{onClick:Ue},{default:l(()=>a[12]||(a[12]=[f("重置")])),_:1,__:[12]}),t(n,{type:"primary",onClick:Fe,loading:B.value},{default:l(()=>a[13]||(a[13]=[f(" 保存权限 ")])),_:1,__:[13]},8,["loading"])]),_:1})]),key:"0"}:void 0]),1032,["title"])]),_:1})]),_:1}),t(Ke,{open:O.value,"onUpdate:open":a[9]||(a[9]=s=>O.value=s),title:P.value?"编辑角色":"创建角色",onOk:Se,"confirm-loading":N.value,width:"600px"},{default:l(()=>[t(re,{ref_key:"roleFormRef",ref:se,model:o,rules:_e,layout:"vertical"},{default:l(()=>[P.value?C("",!0):(i(),h(M,{key:0,label:"角色名称",name:"name"},{default:l(()=>[t(pe,{value:o.name,"onUpdate:value":a[4]||(a[4]=s=>o.name=s),placeholder:"请输入角色名称（英文标识）",disabled:P.value},null,8,["value","disabled"]),a[15]||(a[15]=v("div",{class:"form-help"}," 用于系统内部识别，只能包含字母、数字和下划线 ",-1))]),_:1,__:[15]})),t(M,{label:"显示名称",name:"display_name"},{default:l(()=>[t(pe,{value:o.display_name,"onUpdate:value":a[5]||(a[5]=s=>o.display_name=s),placeholder:"请输入显示名称"},null,8,["value"])]),_:1}),P.value?C("",!0):(i(),h(M,{key:1,label:"角色层级",name:"role_level"},{default:l(()=>[t(J,{value:o.role_level,"onUpdate:value":a[6]||(a[6]=s=>o.role_level=s),placeholder:"请选择角色层级",onChange:we},{default:l(()=>[(i(!0),k(S,null,$(ee.value,s=>(i(),h(g,{key:s.value,value:s.value},{default:l(()=>[f(_(s.label)+" - "+_(s.description),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})),!P.value&&oe.value?(i(),h(M,{key:2,label:"归属公司",name:"company_id"},{default:l(()=>[t(J,{value:o.company_id,"onUpdate:value":a[7]||(a[7]=s=>o.company_id=s),placeholder:"请选择归属公司"},{default:l(()=>[(i(!0),k(S,null,$(ae.value,s=>(i(),h(g,{key:s.id,value:s.id},{default:l(()=>[f(_(s.display_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})):C("",!0),t(M,{label:"角色描述",name:"description"},{default:l(()=>[t(Ne,{value:o.description,"onUpdate:value":a[8]||(a[8]=s=>o.description=s),placeholder:"请输入角色描述",rows:3},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","title","confirm-loading"])])}}},Ra=ea(ka,[["__scopeId","data-v-a66593ba"]]);export{Ra as default};
