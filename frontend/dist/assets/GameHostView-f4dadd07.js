import{g as a,A as pt,x,r as b,G as k,b as gt,a1 as ft,q as yt,J as ht,m as g,c as w,o as v,d as h,e as s,E as N,t as l,w as _,f as i,i as T,s as Ct,v as bt,R as Ot,W as H,h as p,M as j,L as B,F,n as I,K as wt,O as U,y as R,Q as q}from"./index-979b8016.js";import{_ as kt}from"./_plugin-vue_export-helper-c27b6911.js";import{P as V}from"./PlayCircleOutlined-2a71d6ec.js";import{U as L}from"./UserOutlined-0ca42527.js";var xt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M854.6 289.1a362.49 362.49 0 00-79.9-115.7 370.83 370.83 0 00-118.2-77.8C610.7 76.6 562.1 67 512 67c-50.1 0-98.7 9.6-144.5 28.5-44.3 18.3-84 44.5-118.2 77.8A363.6 363.6 0 00169.4 289c-19.5 45-29.4 92.8-29.4 142 0 70.6 16.9 140.9 50.1 208.7 26.7 54.5 64 107.6 111 158.1 80.3 86.2 164.5 138.9 188.4 153a43.9 43.9 0 0022.4 6.1c7.8 0 15.5-2 22.4-6.1 23.9-14.1 108.1-66.8 188.4-153 47-50.4 84.3-103.6 111-158.1C867.1 572 884 501.8 884 431.1c0-49.2-9.9-97-29.4-142zM512 880.2c-65.9-41.9-300-207.8-300-449.1 0-77.9 31.1-151.1 87.6-206.3C356.3 169.5 431.7 139 512 139s155.7 30.5 212.4 85.9C780.9 280 812 353.2 812 431.1c0 241.3-234.1 407.2-300 449.1zm0-617.2c-97.2 0-176 78.8-176 176s78.8 176 176 176 176-78.8 176-176-78.8-176-176-176zm79.2 255.2A111.6 111.6 0 01512 551c-29.9 0-58-11.7-79.2-32.8A111.6 111.6 0 01400 439c0-29.9 11.7-58 32.8-79.2C454 338.6 482.1 327 512 327c29.9 0 58 11.6 79.2 32.8C612.4 381 624 409.1 624 439c0 29.9-11.6 58-32.8 79.2z"}}]},name:"environment",theme:"outlined"};const Et=xt;function J(u){for(var d=1;d<arguments.length;d++){var m=arguments[d]!=null?Object(arguments[d]):{},f=Object.keys(m);typeof Object.getOwnPropertySymbols=="function"&&(f=f.concat(Object.getOwnPropertySymbols(m).filter(function(o){return Object.getOwnPropertyDescriptor(m,o).enumerable}))),f.forEach(function(o){zt(u,o,m[o])})}return u}function zt(u,d,m){return d in u?Object.defineProperty(u,d,{value:m,enumerable:!0,configurable:!0,writable:!0}):u[d]=m,u}var P=function(d,m){var f=J({},d,m.attrs);return a(pt,J({},f,{icon:Et}),null)};P.displayName="EnvironmentOutlined";P.inheritAttrs=!1;const Q=P,St=u=>x({url:"/api/game-host/orders",method:"get",params:u}),Dt=()=>x({url:"/api/game-host/current-order",method:"get"}),Tt=u=>x({url:`/api/game-host/orders/${u}/start`,method:"post"}),$t=(u,d={})=>x({url:`/api/game-host/orders/${u}/complete`,method:"post",data:d}),Gt=()=>x({url:"/api/game-host/stats/today",method:"get"});const Mt={class:"game-host-container"},Ht={class:"status-bar"},Vt={class:"status-info"},Pt={class:"status-item"},At={class:"status-item"},Yt={class:"status-value"},Nt={class:"status-item"},jt={class:"status-value"},Bt={class:"status-actions"},Ft={key:0,class:"current-order-section"},It={class:"section-header"},Ut={class:"section-title"},Rt={class:"order-timer"},qt={class:"current-order-card"},Lt={class:"order-header"},Jt={class:"customer-info"},Qt={class:"customer-name"},Wt={class:"customer-phone"},Xt={class:"order-type"},Zt={class:"order-content"},Kt={class:"content-name"},te={class:"order-details"},ee={class:"detail-item"},se={class:"detail-item"},oe={key:0,class:"support-count"},ae={class:"detail-item"},ne={class:"order-actions"},le={key:1,class:"empty-current-order"},re={class:"empty-icon"},ce={class:"orders-section"},ie={class:"section-header"},de={class:"section-title"},ue={class:"section-filters"},_e={class:"orders-list"},me={key:0,class:"loading-state"},ve={key:1,class:"empty-orders"},pe={key:2,class:"order-cards"},ge={class:"card-header"},fe={class:"customer-info"},ye={class:"customer-name"},he={class:"customer-phone"},Ce={class:"card-status"},be={class:"card-content"},Oe={class:"content-title"},we={class:"content-name"},ke={class:"card-details"},xe={class:"detail-row"},Ee={class:"detail-row"},ze={class:"detail-row"},Se={key:0,class:"support-count"},De={class:"card-actions"},Te={class:"bottom-stats"},$e={class:"stat-item"},Ge={class:"stat-value"},Me={class:"stat-item"},He={class:"stat-value"},Ve={class:"stat-item"},Pe={class:"stat-value"},Ae={class:"stat-item"},Ye={class:"stat-value"},Ne={__name:"GameHostView",setup(u){const d=b(!1),m=b(null),f=b(null),o=b(null),O=b([]),E=b(k()),z=b(null),y=gt({total_orders:0,confirmed_orders:0,in_progress_orders:0,completed_orders:0,script_orders:0,escape_room_orders:0,total_players:0,total_support_players:0});ft((e,t,c)=>(console.error("GameHostView 错误捕获:",e,c),g.error("页面出现错误，请刷新重试"),!1)),yt(async()=>{try{await ht(),console.log("GameHostView 组件挂载完成"),await D()}catch(e){console.error("组件初始化失败:",e),g.error("页面初始化失败，请刷新重试")}});const S=e=>{if(!e)return"--:--";try{return k(e,"HH:mm:ss").format("HH:mm")}catch{return"--:--"}},W=()=>{try{return o.value&&o.value.status==="in_progress"?"status-active":"status-idle"}catch(e){return console.error("计算状态类名失败:",e),"status-idle"}},X=()=>{try{return o.value&&o.value.status==="in_progress"?"游戏进行中":"等待订单"}catch(e){return console.error("计算状态文本失败:",e),"等待订单"}},Z=e=>({confirmed:"blue",in_progress:"orange",completed:"green",cancelled:"red"})[e]||"default",K=e=>({confirmed:"待开始",in_progress:"进行中",completed:"已完成",cancelled:"已取消"})[e]||e,tt=()=>{if(!o.value||!o.value.actual_start_time)return"未开始";try{const e=k(o.value.actual_start_time),c=k().diff(e,"minute"),n=Math.floor(c/60),C=c%60;return n>0?`${n}小时${C}分钟`:`${C}分钟`}catch{return"计算中"}},et=()=>o.value?o.value.order_type==="剧本杀"?o.value.current_script_name||o.value.script_name||"未知剧本":o.value.current_escape_room_name||o.value.escape_room_name||"未知密室":"未知剧本或密室",st=e=>e.status==="in_progress"?"current":e.status==="completed"?"completed":"confirmed",ot=e=>e.order_type==="剧本杀"?e.current_script_name||e.script_name||"未知剧本":e.current_escape_room_name||e.escape_room_name||"未知密室",at=e=>e&&e>k().add(30,"day"),D=async()=>{try{console.log("开始加载数据...");const e=[nt().catch(t=>(console.error("加载当前订单失败:",t),null)),lt().catch(t=>(console.error("加载统计数据失败:",t),null)),$().catch(t=>(console.error("加载订单列表失败:",t),null))];await Promise.allSettled(e),console.log("数据加载完成")}catch(e){console.error("加载数据失败:",e)}},nt=async()=>{try{console.log("正在加载当前订单...");const e=await Dt();console.log("当前订单响应:",e),e&&e.success&&e.data?(o.value=e.data,console.log("当前订单设置成功:",o.value)):(o.value=null,console.log("没有当前订单"))}catch(e){console.error("加载当前订单失败:",e),o.value=null}},lt=async()=>{try{console.log("正在加载统计数据...");const e=await Gt();if(console.log("统计数据响应:",e),e&&e.success&&e.data){const t=e.data;Object.keys(y).forEach(c=>{t.hasOwnProperty(c)&&(y[c]=parseInt(t[c])||0)}),console.log("统计数据更新完成:",y)}}catch(e){console.error("加载统计数据失败:",e)}},$=async()=>{d.value=!0;try{console.log("正在加载订单列表...");const e={start_date:E.value.format("YYYY-MM-DD"),end_date:E.value.format("YYYY-MM-DD")};z.value&&(e.status=z.value),console.log("订单查询参数:",e);const t=await St(e);console.log("订单列表响应:",t),t&&t.success&&Array.isArray(t.data)?(O.value=t.data,console.log("订单列表更新完成，共",O.value.length,"条订单")):(O.value=[],console.log("订单列表为空或格式错误"))}catch(e){console.error("加载订单失败:",e),g.error("加载订单失败"),O.value=[]}finally{d.value=!1}},rt=()=>{$()},ct=()=>{$()},it=async e=>{if(!e||!e.id){console.error("开始游戏失败：订单信息无效",e),g.error("订单信息无效");return}U.confirm({title:"确认开始游戏",icon:R(q),content:`确定要开始 ${e.customer_name||"未知客户"} 的游戏吗？`,okText:"确定",cancelText:"取消",onOk:async()=>{var t,c;m.value=e.id;try{console.log("正在开始游戏，订单ID:",e.id);const n=await Tt(e.id);if(console.log("开始游戏响应:",n),n&&n.success)g.success("游戏开始成功"),await D();else throw new Error((n==null?void 0:n.message)||"开始游戏失败")}catch(n){console.error("开始游戏失败:",n);const C=((c=(t=n.response)==null?void 0:t.data)==null?void 0:c.error)||n.message||"开始游戏失败";g.error(C)}finally{m.value=null}}})},A=async e=>{if(!e||!e.id){console.error("完成游戏失败：订单信息无效",e),g.error("订单信息无效");return}U.confirm({title:"确认完成游戏",icon:R(q),content:`确定要完成 ${e.customer_name||"未知客户"} 的游戏吗？`,okText:"确定",cancelText:"取消",onOk:async()=>{var t,c;f.value=e.id;try{console.log("正在完成游戏，订单ID:",e.id);const n=await $t(e.id,{game_host_notes:"游戏完成"});if(console.log("完成游戏响应:",n),n&&n.success)g.success("游戏完成成功"),await D();else throw new Error((n==null?void 0:n.message)||"完成游戏失败")}catch(n){console.error("完成游戏失败:",n);const C=((c=(t=n.response)==null?void 0:t.data)==null?void 0:c.error)||n.message||"完成游戏失败";g.error(C)}finally{f.value=null}}})},dt=()=>{o.value&&A(o.value)},Y=e=>{g.info("编辑功能开发中...")},ut=()=>{o.value&&Y(o.value)},_t=e=>{g.info("详情功能开发中...")};return(e,t)=>{const c=w("a-button"),n=w("a-tag"),C=w("a-date-picker"),G=w("a-select-option"),mt=w("a-select"),vt=w("a-spin");return v(),h("div",Mt,[s("div",Ht,[s("div",Vt,[s("div",Pt,[t[2]||(t[2]=s("div",{class:"status-label"},"当前状态",-1)),s("div",{class:N(["status-value",W()])},l(X()),3)]),s("div",At,[t[3]||(t[3]=s("div",{class:"status-label"},"今日完成",-1)),s("div",Yt,l(y.completed_orders||0)+"/"+l(y.total_orders||0),1)]),s("div",Nt,[t[4]||(t[4]=s("div",{class:"status-label"},"服务人数",-1)),s("div",jt,l(y.total_players||0)+"人",1)])]),s("div",Bt,[a(c,{onClick:D,loading:d.value,type:"text",class:"refresh-btn"},{default:_(()=>[a(i(Ot)),t[5]||(t[5]=s("span",{class:"refresh-text"},"刷新",-1))]),_:1,__:[5]},8,["loading"])])]),o.value?(v(),h("div",Ft,[s("div",It,[s("div",Ut,[a(i(V),{class:"section-icon active"}),t[6]||(t[6]=s("span",null,"当前进行中",-1))]),s("div",Rt,[a(i(H)),s("span",null,l(tt()),1)])]),s("div",qt,[s("div",Lt,[s("div",Jt,[s("div",Qt,l(o.value.customer_name||"未知客户"),1),s("div",Wt,l(o.value.customer_phone||"无电话"),1)]),s("div",Xt,[a(n,{color:o.value.order_type==="剧本杀"?"blue":"orange",class:"type-tag"},{default:_(()=>[p(l(o.value.order_type||"未知类型"),1)]),_:1},8,["color"])])]),s("div",Zt,[s("div",Kt,l(et()),1),s("div",te,[s("div",ee,[a(i(Q)),s("span",null,l(o.value.room_name||"未分配房间"),1)]),s("div",se,[a(i(L)),s("span",null,l(o.value.player_count||0)+"人",1),o.value.support_player_count>0?(v(),h("span",oe," (+"+l(o.value.support_player_count)+") ",1)):T("",!0)]),s("div",ae,[a(i(H)),s("span",null,l(S(o.value.start_time))+" - "+l(S(o.value.end_time)),1)])])]),s("div",ne,[a(c,{type:"primary",size:"large",onClick:dt,loading:f.value,class:"complete-btn"},{default:_(()=>[a(i(j)),t[7]||(t[7]=p(" 完成游戏 "))]),_:1,__:[7]},8,["loading"]),a(c,{onClick:ut,class:"edit-btn"},{default:_(()=>[a(i(B)),t[8]||(t[8]=p(" 编辑 "))]),_:1,__:[8]})])])])):(v(),h("div",le,[s("div",re,[a(i(V))]),t[9]||(t[9]=s("div",{class:"empty-text"},"暂无进行中的订单",-1)),t[10]||(t[10]=s("div",{class:"empty-subtext"},"等待新订单或从下方列表开始游戏",-1))])),s("div",ce,[s("div",ie,[s("div",de,[a(i(F),{class:"section-icon"}),t[11]||(t[11]=s("span",null,"今日订单",-1))]),s("div",ue,[a(C,{value:E.value,"onUpdate:value":t[0]||(t[0]=r=>E.value=r),onChange:rt,"disabled-date":at,placeholder:"选择日期",size:"small",class:"date-picker"},null,8,["value"]),a(mt,{value:z.value,"onUpdate:value":t[1]||(t[1]=r=>z.value=r),onChange:ct,placeholder:"状态",size:"small","allow-clear":"",class:"status-filter"},{default:_(()=>[a(G,{value:"confirmed"},{default:_(()=>t[12]||(t[12]=[p("待开始")])),_:1,__:[12]}),a(G,{value:"in_progress"},{default:_(()=>t[13]||(t[13]=[p("进行中")])),_:1,__:[13]}),a(G,{value:"completed"},{default:_(()=>t[14]||(t[14]=[p("已完成")])),_:1,__:[14]})]),_:1},8,["value"])])]),s("div",_e,[d.value?(v(),h("div",me,[a(vt,{size:"large"}),t[15]||(t[15]=s("div",null,"加载中...",-1))])):O.value.length===0?(v(),h("div",ve,[a(i(F),{class:"empty-icon"}),t[16]||(t[16]=s("div",{class:"empty-text"},"暂无订单",-1))])):(v(),h("div",pe,[(v(!0),h(Ct,null,bt(O.value,r=>(v(),h("div",{key:r.id,class:N(["order-card",st(r)])},[s("div",ge,[s("div",fe,[s("div",ye,l(r.customer_name||"未知客户"),1),s("div",he,l(r.customer_phone||"无电话"),1)]),s("div",Ce,[a(n,{color:Z(r.status),size:"small"},{default:_(()=>[p(l(K(r.status)),1)]),_:2},1032,["color"])])]),s("div",be,[s("div",Oe,[a(n,{color:r.order_type==="剧本杀"?"blue":"orange",size:"small"},{default:_(()=>[p(l(r.order_type||"未知类型"),1)]),_:2},1032,["color"]),s("span",we,l(ot(r)),1)]),s("div",ke,[s("div",xe,[a(i(Q)),s("span",null,l(r.room_name||"未分配房间"),1)]),s("div",Ee,[a(i(H)),s("span",null,l(S(r.start_time))+" - "+l(S(r.end_time)),1)]),s("div",ze,[a(i(L)),s("span",null,l(r.player_count||0)+"人",1),r.support_player_count>0?(v(),h("span",Se," (+"+l(r.support_player_count)+") ",1)):T("",!0)])])]),s("div",De,[r.status==="confirmed"?(v(),I(c,{key:0,type:"primary",size:"small",onClick:M=>it(r),loading:m.value===r.id,class:"action-btn start-btn"},{default:_(()=>[a(i(V)),t[17]||(t[17]=p(" 开始游戏 "))]),_:2,__:[17]},1032,["onClick","loading"])):T("",!0),r.status==="in_progress"?(v(),I(c,{key:1,type:"primary",size:"small",onClick:M=>A(r),loading:f.value===r.id,class:"action-btn complete-btn"},{default:_(()=>[a(i(j)),t[18]||(t[18]=p(" 完成游戏 "))]),_:2,__:[18]},1032,["onClick","loading"])):T("",!0),a(c,{size:"small",onClick:M=>Y(),disabled:r.status==="completed",class:"action-btn edit-btn"},{default:_(()=>[a(i(B)),t[19]||(t[19]=p(" 编辑 "))]),_:2,__:[19]},1032,["onClick","disabled"]),a(c,{size:"small",onClick:M=>_t(),class:"action-btn detail-btn"},{default:_(()=>[a(i(wt)),t[20]||(t[20]=p(" 详情 "))]),_:2,__:[20]},1032,["onClick"])])],2))),128))]))])]),s("div",Te,[s("div",$e,[s("div",Ge,l(y.total_orders||0),1),t[21]||(t[21]=s("div",{class:"stat-label"},"总订单",-1))]),s("div",Me,[s("div",He,l(y.completed_orders||0),1),t[22]||(t[22]=s("div",{class:"stat-label"},"已完成",-1))]),s("div",Ve,[s("div",Pe,l(y.total_players||0),1),t[23]||(t[23]=s("div",{class:"stat-label"},"总人数",-1))]),s("div",Ae,[s("div",Ye,l(y.total_support_players||0),1),t[24]||(t[24]=s("div",{class:"stat-label"},"补位",-1))])])])}}},Ue=kt(Ne,[["__scopeId","data-v-c3dab015"]]);export{Ue as default};
