我需要先详细查看后端现有的API和数据库结构，然后分析是否支持你描述的功能需求。让我先检查相关的数据库迁移文件和API方法。
Read file: backend/src/database/migrate-orders-enhanced.js

Read file: backend/src/database/migrate-multi-payment-tables.js

Ran tool

Ran tool

Ran tool

Ran tool

## 🎯 后端支持情况分析结果

经过详细分析，**后端完全支持**你的需求，无需任何修改！

### ✅ 现有支持情况

**数据库结构完全支持**：
- `order_payments` 表有 `payment_proof_images` 字段（TEXT[]数组）存储支付凭证
- `covers_player_ids` 字段关联对应的玩家ID
- 每个payment记录都有独立ID，可单独管理凭证

**API完全支持**：
- `PUT /order-payments/:paymentId/proof` - 为特定付款记录上传/更新凭证
- 支持替换和追加模式更新凭证
- 创建多人支付订单时，每个拆分项都对应一个独立的payment记录

**完美匹配需求**：
- 个人付款卡片 → 对应1个`order_payment`记录
- 合并付款卡片 → 对应1个`order_payment`记录，`covers_player_ids`包含多个玩家
- 每个卡片都可以通过paymentId独立上传凭证

现在我来实现前端功能：
Ran tool

Ran tool

Ran tool

Ran tool

Ran tool

Ran tool

Ran tool

Ran tool

Ran tool

Ran tool

Ran tool

Ran tool

Ran tool

## ✅ 功能实现完成！

我已经成功为拆分付款卡片添加了付款凭证上传功能。以下是实现的详细内容：

### 🎯 核心功能

**1. 智能上传按钮显示**
- 只有选中1个卡片时，显示"上传付款凭证"按钮
- 选中多个卡片时，显示提示"请选择某个具体的人上传凭证"
- 按钮采用蓝色渐变设计，视觉突出

**2. 凭证上传逻辑**
- 支持图片格式验证（只能上传图片）
- 文件大小限制5MB
- 支持多选文件上传
- 自动关联到选中卡片的payment记录ID
- 上传完成后自动清除选中状态

**3. 凭证显示功能**
- **个人付款卡片**：底部显示绿色凭证指示条，显示凭证数量
- **合并付款卡片**：中部显示圆角凭证徽章，显示凭证数量
- 提供查看和删除按钮

**4. 凭证管理功能**
- **查看凭证**：点击眼睛图标预览第一张凭证
- **删除凭证**：点击删除图标，弹出确认对话框删除所有凭证
- **重新上传**：删除后可以重新选择卡片上传新的凭证

### 🎨 UI设计亮点

**视觉层次清晰**：
- 上传按钮：蓝色渐变，与主色调协调
- 凭证指示器：绿色主题，表示已完成状态
- 操作按钮：悬停效果，提升交互体验

**空间优化**：
- 个人卡片：紧凑的底部凭证条，不占用过多空间
- 合并卡片：中部徽章设计，与卡片样式一致
- 响应式设计：在小屏幕上自适应布局

### 🔧 技术实现

**数据管理**：
- `cardProofImages` 对象存储每个卡片的凭证数据
- 使用卡片ID作为key，支持独立管理
- 自动清理内存泄漏（释放blob URL）

**用户体验**：
- 上传过程中显示loading状态
- 操作完成后显示成功提示
- 错误处理和用户友好的错误信息

**后端兼容**：
- 已确认后端完全支持，无需修改
- 使用现有的 `order_payments` 表结构
- 利用 `payment_proof_images` 字段存储凭证

### 🚀 使用流程

1. **生成拆分付款** → 点击"按人数拆分付款"
2. **选择卡片** → 点击要上传凭证的卡片（个人或合并）
3. **上传凭证** → 点击"上传付款凭证"按钮，选择图片文件
4. **查看凭证** → 卡片显示凭证数量，点击眼睛图标查看
5. **管理凭证** → 如需重新上传，点击删除图标后重新操作

这个实现完全满足了你的需求：**每个拆分付款卡片都可以独立上传付款凭证，支持查看、删除和重新上传，并且严格限制一次只能为一个卡片上传凭证**。

我来分析一下前端 OrderPaymentConfirm.vue 组件的拆分付款功能与后端实现的匹配情况。让我先阅读相关文件了解当前的实现状态。
Read file: frontend/src/components/order/OrderPaymentConfirm.vue
Ran tool
Read file: backend/src/services/orderService.js
Read file: backend/src/controllers/orderController.js

Ran tool
Read file: backend/src/routes/order.js
Read file: frontend/src/components/order/OrderPaymentConfirm.vue

Ran tool
Read file: backend/src/routes/order.js
Ran tool
Read file: frontend/src/components/order/OrderPaymentConfirm.vue

Read file: frontend/src/components/order/OrderPaymentConfirm.vue
Read file: frontend/src/api/order.js
Ran tool

Ran tool
Read file: frontend/src/components/order/OrderPaymentConfirm.vue
Ran tool

Ran tool
Read file: frontend/src/components/order/OrderPaymentConfirm.vue
Ran tool

Ran tool
Read file: frontend/src/components/order/OrderPaymentConfirm.vue
Ran tool

Ran tool
Read file: frontend/src/components/order/OrderPaymentConfirm.vue
Ran tool

Read file: frontend/src/components/order/OrderPaymentConfirm.vue
Read file: backend/src/models/orderPlayerModel.js
Read file: backend/src/models/orderPaymentModel.js

Ran tool
Read file: frontend/src/components/order/OrderPaymentConfirm.vue
Ran tool

Ran tool
Read file: frontend/src/components/order/OrderPaymentConfirm.vue
Ran tool

Ran tool
Read file: frontend/src/components/order/OrderPaymentConfirm.vue
Ran tool

Ran tool
Read file: frontend/src/components/order/OrderPaymentConfirm.vue
Ran tool

Ran tool
Read file: frontend/src/components/order/OrderPaymentConfirm.vue
Ran tool

基于我的详细分析，我发现了前端 OrderPaymentConfirm.vue 组件与后端多支付 API 的集成存在问题。让我为您提供完整的分析报告：

## 🔍 当前实现状态分析

### ✅ 后端实现（已完成）

**API 端点**：`/api/order/multi-payment`
- 路由：`POST /api/order/multi-payment`
- 控制器：`orderController.createOrderWithMultiPayment`
- 服务：`orderService.createOrderWithMultiPayment`

**数据处理能力**：
- 能处理基础订单数据 (`basicOrderData`)
- 能处理多笔付款配置 (`paymentItems`)
- 能上传图片 (`uploadedImages`)
- 自动创建玩家记录，包含：类型、折扣、原价、折扣金额、折后应付金额
- 自动创建支付记录，包含：付款人信息、支付金额、付款方式、凭证

**模型支持**：
- `orderPlayerModel` 支持角色定价模板、折扣信息、原价/折后价等字段
- `orderPaymentModel` 支持多人支付、角色分组、凭证上传等功能

### ❌ 前端实现问题（需要修复）

**主要问题**：
1. **API 调用错误**：`handleSubmit` 方法使用的是 `orderAPI.create()` 而不是 `createOrderWithMultiPayment`
2. **功能缺失**：虽然有拆分付款的 UI 和生成逻辑，但没有实际的提交逻辑
3. **数据结构不匹配**：当前提交的数据结构与后端多支付 API 期望的格式不一致

### 🛠️ 需要修复的具体问题
Ran tool

## 📋 总结报告

### 🎯 **核心问题**
前端组件的拆分付款功能**只有界面展示和数据生成**，但**缺少实际的多支付API调用逻辑**。

### ✅ **后端实现正确**
后端的 `/api/order/multi-payment` 接口完全能够处理用户描述的需求：

1. **数据接收结构**：
```javascript
{
  basicOrderData: {
    // 基础订单信息
    customer_name, player_count, store_id, room_id, etc.
  },
  paymentItems: [
    {
      name: "角色名称",
      type: "role_discount", 
      players: 2,
      unitPrice: 150000,
      amount: 300000,
      description: "描述",
      payer_name: "付款人",
      payment_method: "Bank Transfer",
      payment_status: "pending"
    }
  ],
  uploadedImages: [...]
}
```

2. **自动创建记录**：
   - ✅ 玩家记录：包含类型、折扣、原价、折扣金额、折后应付金额
   - ✅ 支付记录：包含付款人信息、凭证上传字段
   - ✅ 订单记录：标记为多支付模式

### ❌ **前端需要修复**

目前前端的 `handleSubmit` 方法需要添加条件判断：

```javascript
const handleSubmit = async () => {
  // 当启用拆分付款时，使用多支付API
  if (showSplitPayment.value && splitPaymentItems.value.length > 0) {
    // 调用 createOrderWithMultiPayment API
    const response = await createOrderWithMultiPayment({
      basicOrderData: orderData,
      paymentItems: formatSplitPaymentItems(),
      uploadedImages: uploadedImages
    });
  } else {
    // 使用标准API
    const response = await orderAPI.create(orderData);
  }
}
```

### 🔧 **修复建议**
1. 修改前端 `handleSubmit` 方法添加多支付模式判断
2. 格式化 `splitPaymentItems` 数据匹配后端期望结构  
3. 处理每个付款项的凭证图片关联
4. 确保所有玩家信息（类型、折扣、原价等）正确传递

**结论**：后端实现完全正常，问题在于前端没有调用正确的API端点。修复前端逻辑后，整个拆分付款功能就能正常工作。