# 角色层级系统重构总结

## 问题描述

用户反馈现有权限系统逻辑不正确：
- 平台级、公司级、门店级用户都在使用同一套角色
- 没有实现真正的角色层级分离
- 角色与权限应该按层级归属，而不是全局共享

## 重构目标

实现真正的角色层级分离：
1. **平台级角色**：只有平台级用户能看到和使用
2. **公司级角色**：归属特定公司，只有该公司用户能看到和使用  
3. **门店级角色**：归属特定公司，只有门店级用户能看到和使用

## 核心架构变更

### 1. 数据库结构优化

**新增字段**：
- `roles.role_level` - 角色层级字段 (`platform`, `company`, `store`)
- 修改唯一约束：`(company_id, role_level, name)` 确保同层级内角色名唯一

**角色分布**：
- **平台级角色**：`company_id = NULL`, `role_level = 'platform'`
- **公司级角色**：`company_id = 具体公司ID`, `role_level = 'company'`
- **门店级角色**：`company_id = 具体公司ID`, `role_level = 'store'`

### 2. 权限配置重构

**移除硬编码**：
- 删除 `ROLE_PERMISSIONS` 硬编码配置
- 改为完全基于数据库的动态权限系统

**新增层级访问规则**：
```javascript
const ROLE_LEVEL_ACCESS_RULES = {
  platform: { canView: ['platform'], canManage: ['platform'] },
  company: { canView: ['company', 'store'], canManage: ['company', 'store'] },
  store: { canView: ['store'], canManage: ['store'] }
};
```

### 3. 权限检查逻辑重写

**PermissionChecker 类重构**：
- `hasPermission()` - 改为从数据库获取权限
- `getViewableRoleLevels()` - 获取可查看的角色层级
- `canManageRoleLevel()` - 检查是否可管理指定层级角色
- 移除所有硬编码的角色权限逻辑

### 4. 数据访问控制

**角色查询分离**：
- 平台级用户：只查询 `role_level = 'platform'` 且 `company_id IS NULL`
- 公司级用户：查询本公司的 `role_level IN ('company', 'store')`
- 门店级用户：只查询本公司的 `role_level = 'store'`

## 实施步骤

### 1. 数据库迁移 ✅
- 执行 `migrate-permissions-v2.js`
- 添加 `role_level` 字段
- 重新创建角色层级结构
- 更新用户角色关联

### 2. 代码重构 ✅
- 重写 `permissions.js` 配置
- 重构 `PermissionChecker` 类
- 更新 `permissionModel.js` 查询逻辑
- 修改 `permissionService.js` 业务逻辑

### 3. 服务层更新 ✅
- 更新 `userService.js` 角色管理逻辑
- 修改 `permissionController.js` 接口逻辑
- 移除所有硬编码的角色检查

## 测试验证结果

### 角色层级分离验证 ✅
- **平台级**：2个角色，0个公司
- **公司级**：24个角色，8个公司  
- **门店级**：40个角色，8个公司

### 权限访问验证 ✅
- **平台级用户**：只能看到平台级角色（2个）
- **公司级用户**：可以看到公司级+门店级角色（8个）
- **门店级用户**：只能看到门店级角色（5个）

### 功能权限验证 ✅
- 各层级用户都有正确的功能权限
- 权限检查基于数据库动态获取
- 不再依赖硬编码配置

## 核心优势

### 1. 真正的层级分离
- 每个层级有独立的角色体系
- 角色归属明确，不会混淆
- 符合企业级权限管理需求

### 2. 灵活的权限配置
- 完全基于数据库的动态权限
- 可以为每个角色单独配置权限
- 支持细粒度的权限控制

### 3. 清晰的数据隔离
- 平台级：管理所有数据
- 公司级：只管理本公司数据
- 门店级：只管理本门店数据

### 4. 可扩展性
- 新增角色只需在数据库中创建
- 权限配置完全可视化管理
- 支持多租户架构

## 关键设计原则

1. **层级归属**：角色必须归属于特定层级和公司
2. **权限分离**：功能权限与数据权限完全分离
3. **动态配置**：所有权限配置基于数据库，不硬编码
4. **安全隔离**：严格的数据访问控制，防止越权访问

## 后续优化建议

1. **前端适配**：更新前端权限管理界面，支持角色层级显示
2. **权限继承**：考虑实现上级角色权限继承机制
3. **审计日志**：添加权限变更的审计日志功能
4. **批量操作**：支持批量角色和权限管理操作

---

**重构完成时间**：2025年6月14日  
**影响范围**：权限系统核心架构  
**向后兼容**：通过数据迁移保证现有用户正常使用 