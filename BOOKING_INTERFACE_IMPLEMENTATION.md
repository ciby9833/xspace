# 预订界面功能实现说明

## 概述

本文档描述了新实现的类似电影票预订的在线预订界面功能。该界面提供了更直观、用户友好的预订体验，支持剧本杀和密室的统一预订流程。

## 功能特性

### 🎯 界面设计
- **顶部选项卡**：全部、剧本杀、密室三个类型切换
- **左侧筛选区**：根据类型显示不同的筛选条件
- **中间项目列表**：卡片式展示，带封面图片
- **右侧详情区**：项目详情、门店选择、时间预订

### 🔍 筛选功能
- **剧本杀筛选**：剧本类型、难度等级、人数、价格
- **密室筛选**：恐怖等级、NPC数量、人数、价格
- **通用筛选**：人数范围、价格范围
- **实时筛选**：无需刷新页面

### 📱 用户体验
- **图片预览**：支持多图片轮播展示
- **实时可用性**：动态显示房间时间段可用状态
- **权限适配**：根据用户权限显示不同门店选项
- **响应式设计**：支持移动端和桌面端

## 后端接口

### 新增接口

#### 1. 获取可预订项目列表
```
GET /api/order/booking/items?item_type=all|script|escape_room
```

**功能**：统一获取剧本杀和密室项目，支持类型筛选  
**返回数据**：
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "uuid",
        "type": "script|escape_room",
        "name": "项目名称",
        "cover_image": "封面图片URL",
        "images": ["图片URL数组"],
        "min_players": 4,
        "max_players": 8,
        "duration": 120,
        "price": 50000,
        "category": "类型分类",
        "description": "项目描述",
        "store_count": 3
      }
    ],
    "categories": {
      "script_types": [{"type": "推理", "count": 5}],
      "escape_room_horror_levels": [{"horror_level": "微恐", "count": 3}]
    }
  }
}
```

#### 2. 获取项目详情页数据
```
GET /api/order/booking/item/:itemType/:itemId
```

**功能**：获取项目详情和可选门店信息  
**返回数据**：包含项目完整信息、可选门店列表、房间信息

#### 3. 获取门店房间时间表
```
GET /api/order/booking/store/:storeId/schedule?date=2024-01-15
```

**功能**：获取指定日期的房间时间段可用性  
**返回数据**：各房间的时间段列表和占用状态

#### 4. 预检查预订可用性
```
POST /api/order/booking/pre-check
```

**功能**：在正式下单前检查选择的时间段是否可用  
**请求数据**：门店、房间、项目、时间信息

## 前端组件

### BookingView.vue
**位置**：`frontend/src/views/BookingView.vue`  
**功能**：主预订界面组件

**主要特性**：
- 三段式布局（筛选-列表-详情）
- 响应式设计适配
- 图片预览功能
- 实时数据加载
- 权限控制集成

### 路由配置
```javascript
{
  path: '/booking',
  name: 'Booking',
  component: () => import('@/views/BookingView.vue'),
  meta: { 
    title: '在线预订',
    permission: 'order.view'
  }
}
```

## 数据库支持

### 现有表结构
当前的数据库表结构已经完全支持新的预订界面需求：

- **scripts表**：剧本信息（含images字段存储图片）
- **escape_rooms表**：密室信息（含cover_images字段存储图片）
- **store_scripts表**：门店剧本配置和价格
- **store_escape_rooms表**：门店密室配置和价格
- **rooms表**：房间信息
- **orders表**：订单信息（用于检查时间冲突）

### 无需表结构修改
经过分析，现有的表结构已经包含了所有必要的字段：
- ✅ 图片存储：scripts.images、escape_rooms.cover_images
- ✅ 门店价格：store_scripts.store_price、store_escape_rooms.store_price
- ✅ 项目属性：类型、人数、时长、难度等
- ✅ 房间管理：房间状态、容量信息
- ✅ 时间冲突检查：通过orders表查询

## 权限集成

### 权限要求
- **查看权限**：`order.view` - 查看预订界面和项目信息
- **预订权限**：`order.create` - 创建预订订单

### 账户层级支持
- **平台级**：可查看所有公司的项目
- **公司级**：可查看本公司所有门店的项目
- **门店级**：只能查看本门店的项目

## 使用流程

### 用户预订流程
1. **选择类型**：在顶部选择"全部"、"剧本杀"或"密室"
2. **筛选项目**：使用左侧筛选条件缩小选择范围
3. **浏览项目**：在中间列表查看项目卡片，点击选择
4. **查看详情**：右侧显示项目详细信息和图片
5. **选择门店**：从可用门店中选择一个
6. **选择时间**：选择日期和可用时间段
7. **确认预订**：检查信息后提交预订

### 开发使用流程
1. **访问地址**：`/booking`
2. **权限要求**：需要`order.view`权限
3. **API调用**：使用`/api/order/booking/*`系列接口
4. **数据格式**：统一的JSON响应格式

## 测试支持

### 测试文件
**位置**：`backend/test-booking-interface.js`  
**功能**：验证所有新增接口的功能

**测试覆盖**：
- ✅ 项目列表获取
- ✅ 项目详情查询
- ✅ 房间时间表查询
- ✅ 预订可用性检查

### 运行测试
```bash
cd backend
node test-booking-interface.js
```

## 扩展建议

### 近期优化
1. **搜索功能**：添加项目名称关键词搜索
2. **收藏功能**：允许用户收藏喜欢的项目
3. **推荐算法**：根据用户历史推荐项目
4. **评价系统**：项目评分和评价展示

### 长期规划
1. **移动端应用**：开发专门的移动端预订应用
2. **第三方集成**：对接外部预订平台
3. **实时通知**：WebSocket实时推送可用性变化
4. **智能排期**：AI辅助的最优时间推荐

## 技术架构

### 前端技术栈
- **Vue 3** + **Composition API**：现代化的响应式框架
- **Ant Design Vue**：企业级UI组件库
- **Day.js**：轻量级日期处理库
- **Vue Router**：单页面应用路由

### 后端技术栈
- **Node.js** + **Express**：高性能Web服务器
- **PostgreSQL**：关系型数据库
- **JWT**：用户认证授权
- **Multer**：文件上传处理

### 数据交互
- **RESTful API**：标准的HTTP接口设计
- **JSON格式**：统一的数据交换格式
- **权限中间件**：细粒度的访问控制
- **错误处理**：完整的异常捕获机制

## 总结

新的预订界面功能提供了：
- 🎨 **现代化UI**：类似主流预订平台的用户体验
- 🔐 **权限控制**：完整的多层级权限管理
- 📊 **数据完整**：支持所有必要的业务数据
- 🚀 **性能优化**：高效的数据查询和渲染
- 📱 **响应式设计**：适配各种设备屏幕
- 🧪 **测试覆盖**：完整的接口功能验证

该功能完全基于现有的数据库结构，无需修改表结构，实现了快速部署和上线。 