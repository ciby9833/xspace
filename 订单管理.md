根据您提供的剧本杀和密室订单录入需求以及现有数据库结构，我来设计一个统一的订单表结构方案。

## 订单表结构设计方案

### 1. 核心订单表 (orders)

```sql
CREATE TABLE orders (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  
  -- 基础关联信息
  company_id UUID REFERENCES company(id) ON DELETE CASCADE,
  store_id UUID REFERENCES store(id) ON DELETE CASCADE,
  room_id UUID REFERENCES rooms(id) ON DELETE SET NULL,
  
  -- 订单基础信息
  order_type VARCHAR(20) CHECK (order_type IN ('剧本杀', '密室')) NOT NULL,
  order_date DATE NOT NULL,
  weekday VARCHAR(10) NOT NULL, -- 周一到周日
  language VARCHAR(10) CHECK (language IN ('CN', 'IND')) NOT NULL,
  
  -- 时间信息
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  duration INTEGER, -- 实际时长（分钟）
  
  -- 客户信息
  customer_name VARCHAR(100) NOT NULL,
  customer_phone VARCHAR(20) NOT NULL,
  player_count INTEGER NOT NULL CHECK (player_count > 0),
  internal_support BOOLEAN DEFAULT false, -- 是否内部人补位
  
  -- 剧本杀专用字段
  script_id UUID REFERENCES scripts(id) ON DELETE SET NULL,
  script_name VARCHAR(255), -- 冗余字段，防止剧本删除后丢失信息
  game_host_id UUID REFERENCES users(id) ON DELETE SET NULL,
  npc_id UUID REFERENCES users(id) ON DELETE SET NULL,
  
  -- 密室专用字段
  escape_room_id UUID REFERENCES escape_rooms(id) ON DELETE SET NULL,
  escape_room_name VARCHAR(255), -- 冗余字段
  is_group_booking BOOLEAN DEFAULT false, -- Gabung: YES/NO
  include_photos BOOLEAN DEFAULT false,
  include_cctv BOOLEAN DEFAULT false,
  
  -- 预订信息
  booking_type VARCHAR(50) CHECK (booking_type IN ('Booking', 'Walk In', 'Traveloka', 'Tiket.com', 'Gamehost/Staff Booking', 'MyValue（Gramedia）')) NOT NULL,
  
  -- 费用信息
  is_free BOOLEAN DEFAULT false, -- Free/Pay
  unit_price DECIMAL(10,2),
  total_amount DECIMAL(10,2) NOT NULL,
  payment_status VARCHAR(20) CHECK (payment_status IN ('FULL', 'Not Yet', 'DP', 'Free')) NOT NULL,
  payment_date DATE,
  payment_method VARCHAR(50) CHECK (payment_method IN ('Bank Transfer', 'QR BCA', 'DEBIT', 'CC')),
  
  -- 优惠信息
  promo_code VARCHAR(100),
  promo_quantity INTEGER DEFAULT 0,
  promo_discount DECIMAL(10,2) DEFAULT 0,
  
  -- 负责人信息
  pic_id UUID REFERENCES users(id) ON DELETE SET NULL, -- 负责人
  pic_payment_id UUID REFERENCES users(id) ON DELETE SET NULL, -- 收款负责人
  
  -- 其他信息
  notes TEXT,
  proof_images JSONB DEFAULT '[]', -- 支付凭证图片
  
  -- 状态和时间戳
  status VARCHAR(20) CHECK (status IN ('pending', 'confirmed', 'in_progress', 'completed', 'cancelled')) DEFAULT 'pending',
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id) ON DELETE SET NULL,
  updated_by UUID REFERENCES users(id) ON DELETE SET NULL
);
```

### 2. 订单配置表 (order_configs)

用于存储可编辑的选项配置：

```sql
CREATE TABLE order_configs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  company_id UUID REFERENCES company(id) ON DELETE CASCADE,
  config_type VARCHAR(50) NOT NULL, -- 'game_host', 'npc', 'promo', 'pic', 'pic_payment'
  config_key VARCHAR(100) NOT NULL,
  config_value VARCHAR(255) NOT NULL,
  is_active BOOLEAN DEFAULT true,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(company_id, config_type, config_key)
);
```

### 3. 订单图片表 (order_images)

用于存储支付凭证等图片：

```sql
CREATE TABLE order_images (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  order_id UUID REFERENCES orders(id) ON DELETE CASCADE,
  image_type VARCHAR(20) CHECK (image_type IN ('proof', 'other')) NOT NULL,
  image_url VARCHAR(500) NOT NULL,
  image_name VARCHAR(255),
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

## 字段映射关系

### 剧本杀字段映射
| 原字段 | 新字段 | 类型 | 说明 |
|--------|--------|------|------|
| 星期 | weekday | VARCHAR | 周一到周日 |
| 日期 | order_date | DATE | 订单日期 |
| 中文&印尼文 | language | VARCHAR | CN/IND |
| 玩家姓名 | customer_name | VARCHAR | 客户姓名 |
| 玩家电话号 | customer_phone | VARCHAR | 客户电话 |
| 人数 | player_count | INTEGER | 玩家人数 |
| 是否内部人补位 | internal_support | BOOLEAN | 是否内部补位 |
| 剧本 | script_id, script_name | UUID, VARCHAR | 关联剧本表 |
| 房间 | room_id | UUID | 关联房间表 |
| 时间 | start_time, end_time | TIME | 开始结束时间 |
| Game Host | game_host_id | UUID | 关联用户表 |
| NPC | npc_id | UUID | 关联用户表 |
| Free/Pay | is_free | BOOLEAN | 是否免费 |
| Payment | payment_status | VARCHAR | 支付状态 |
| Payment Date | payment_date | DATE | 支付日期 |
| Price | unit_price | DECIMAL | 单价 |
| Total Invoice | total_amount | DECIMAL | 总金额 |
| Proof | proof_images | JSONB | 支付凭证 |
| PIC | pic_id | UUID | 负责人 |
| PIC Payment | pic_payment_id | UUID | 收款负责人 |
| Booking/Walk in | booking_type | VARCHAR | 预订类型 |
| Promo | promo_code | VARCHAR | 优惠码 |
| Qty Promo | promo_quantity | INTEGER | 优惠数量 |
| Payment Method | payment_method | VARCHAR | 支付方式 |
| 备注 | notes | TEXT | 备注信息 |

### 密室字段映射
| 原字段 | 新字段 | 类型 | 说明 |
|--------|--------|------|------|
| 密室主题 | escape_room_id, escape_room_name | UUID, VARCHAR | 关联密室表 |
| Gabung | is_group_booking | BOOLEAN | 是否拼团 |
| Photos | include_photos | BOOLEAN | 是否包含拍照 |
| CCTV | include_cctv | BOOLEAN | 是否包含监控 |
| 其他字段 | 同剧本杀映射 | - | 共用字段 |

## 功能特性

### 1. 灵活配置
- 通过 `order_configs` 表实现可编辑选项
- 支持公司级别的配置隔离
- 动态添加/删除/编辑选项内容

### 2. 自动计算
- `total_amount` 可通过触发器自动计算：`unit_price * player_count - promo_discount`
- 支持优惠折扣计算

### 3. 多媒体支持
- 支持多张支付凭证图片上传
- 图片与人数可以一对一或一对多关联

### 4. 权限控制
- 基于现有用户权限系统
- 支持公司/门店级别的数据隔离

### 5. 数据完整性
- 外键约束确保数据一致性
- 软删除支持（is_active字段）
- 审计字段（created_by, updated_by）

## 索引建议

```sql
-- 性能优化索引
CREATE INDEX idx_orders_company_store ON orders(company_id, store_id);
CREATE INDEX idx_orders_date_type ON orders(order_date, order_type);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_customer_phone ON orders(customer_phone);
CREATE INDEX idx_orders_booking_type ON orders(booking_type);
CREATE INDEX idx_order_configs_company_type ON order_configs(company_id, config_type);
```

这个设计方案既满足了剧本杀和密室的所有录入需求，又保持了数据结构的灵活性和可扩展性，同时与现有的用户、公司、门店、房间等表结构完美集成。